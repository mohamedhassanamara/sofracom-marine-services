<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>SOFRACOM • Products</title>

    <!-- Tailwind -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root{ --deep-navy:#0b2050; --sea:#0f3d72; --accent:#24b4ff; }
        html,body{font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
        .nav-glass{backdrop-filter:blur(10px); background:rgba(11,32,80,.55)}
        .nav-solid{background:var(--deep-navy)}
        [data-animate]{opacity:0; transform:translateY(20px); transition:all .6s ease}
        .in-view{opacity:1; transform:translateY(0)}
        .tilt{transform-style:preserve-3d; transition:transform .2s ease, box-shadow .2s ease}
        .tilt:hover{box-shadow:0 20px 45px rgba(0,0,0,.15)}
        .tilt .layer{transform:translateZ(18px)}
        .card-img{width:100%;height:220px;object-fit:contain;background:#f3f4f6;display:block;border-radius:0.75rem}
        .price{color:#0b2050}
        .tag{background:rgba(36,180,255,.12); color:#0f3d72}
        .stock-badge{display:inline-flex; align-items:center; gap:0.35rem; padding:0.25rem 0.6rem; border-radius:999px; font-size:0.75rem; font-weight:600}
        .stock-badge--in{background:rgba(15,122,46,.12); color:#0f7a2e; border:1px solid rgba(15,122,46,.22)}
        .stock-badge--out{background:rgba(215,38,56,.12); color:#d72638; border:1px solid rgba(215,38,56,.2)}
        .product-out .card-img{filter:grayscale(.25); opacity:.8}
        .product-out .price{opacity:.7}
        .cart-fab{position:fixed; bottom:1.5rem; right:1.5rem; z-index:60; display:flex; align-items:center; gap:0.5rem; background:var(--deep-navy); color:#fff; padding:0.85rem 1.2rem; border-radius:999px; box-shadow:0 12px 24px rgba(11,32,80,.35); font-weight:600; transition:transform .2s ease, box-shadow .2s ease}
        .cart-fab:hover{transform:translateY(-2px); box-shadow:0 16px 32px rgba(11,32,80,.4)}
        .cart-overlay{position:fixed; inset:0; background:rgba(11,32,80,.35); backdrop-filter:blur(2px); z-index:70; opacity:0; pointer-events:none; transition:opacity .25s ease}
        .cart-overlay.active{opacity:1; pointer-events:auto}
        .cart-drawer{position:fixed; top:0; right:0; height:100%; width:min(420px,100vw); background:#fff; z-index:80; transform:translateX(100%); transition:transform .28s ease; display:flex; flex-direction:column; box-shadow:-8px 0 24px rgba(11,32,80,.18)}
        .cart-drawer.open{transform:translateX(0)}
        .cart-header{padding:1.25rem 1.5rem; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid rgba(15,61,114,.12)}
        .cart-body{flex:1; overflow-y:auto; padding:1rem 1.5rem}
        .cart-item{display:grid; grid-template-columns:64px 1fr; gap:0.75rem; padding:0.75rem 0; border-bottom:1px solid rgba(15,61,114,.08)}
        .cart-item:last-child{border-bottom:none}
        .cart-item img{width:64px; height:64px; object-fit:cover; border-radius:0.5rem; background:#f3f4f6}
        .cart-item-title{font-weight:600; color:#0b2050}
        .cart-qty{display:inline-flex; align-items:center; gap:0.4rem; border:1px solid rgba(11,32,80,.15); border-radius:999px; padding:0.25rem 0.6rem}
        .cart-qty button{border:none; background:transparent; font-weight:700; cursor:pointer; padding:0 0.3rem}
        .cart-qty input{width:2.5rem; border:none; text-align:center; font-weight:600; background:transparent}
        .cart-summary{padding:1rem 1.5rem; border-top:1px solid rgba(15,61,114,.12)}
        .cart-summary-row{display:flex; justify-content:space-between; font-weight:600; color:#0b2050}
        .cart-form{padding:1rem 1.5rem 1.5rem; border-top:1px solid rgba(15,61,114,.12); display:grid; gap:0.75rem}
        .cart-form label{display:grid; gap:0.35rem; font-size:0.85rem; font-weight:600; color:#0b2050}
        .cart-form input,.cart-form textarea{border:1px solid rgba(11,32,80,.18); border-radius:0.65rem; padding:0.6rem 0.75rem; font-size:0.95rem; font-family:inherit; transition:border-color .2s ease, box-shadow .2s ease}
        .cart-form input:focus,.cart-form textarea:focus{outline:none; border-color:var(--accent); box-shadow:0 0 0 3px rgba(36,180,255,.2)}
        .cart-submit{background:var(--deep-navy); color:#fff; border:none; border-radius:0.75rem; padding:0.8rem 1rem; font-weight:600; cursor:pointer; transition:background .2s ease, transform .2s ease}
        .cart-submit:disabled{opacity:.6; cursor:not-allowed}
        .cart-submit:hover:not(:disabled){background:var(--sea); transform:translateY(-1px)}
        .product-card{border-radius:1.2rem; overflow:hidden; display:flex; flex-direction:column; background:#fff; transition:transform .2s ease, box-shadow .2s ease; border:1px solid rgba(15,61,114,.08)}
        .product-card:hover{transform:translateY(-4px); box-shadow:0 20px 40px rgba(15,61,114,.15)}
        .product-description{margin:0; color:#475569; display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden; transition:max-height .2s ease}
        .product-description.expanded{-webkit-line-clamp:unset; max-height:none}
        .read-more-btn{background:none;border:none;color:#2563eb;font-weight:600;margin-top:0.5rem;cursor:pointer;padding:0;font-size:0.85rem}
        .product-price-row{display:flex; align-items:center; justify-content:space-between; gap:0.75rem; flex-wrap:wrap}
        .product-actions{display:flex; align-items:center; justify-content:space-between; gap:0.75rem; flex-wrap:wrap}
        .product-actions a{font-size:0.85rem; color:#2563eb; font-weight:600}
        .product-detail-btn{background:none;border:none;padding:0;font-size:0.85rem;color:#2563eb;font-weight:600;cursor:pointer}
        .product-detail-btn:hover{text-decoration:underline}
        .product-variants{margin-top:0.75rem; display:flex; flex-wrap:wrap; gap:0.5rem}
        .variant-option{border:1px solid rgba(15,61,114,.2); border-radius:999px; padding:0.35rem 0.9rem; background:#f8fafc; cursor:pointer; font-size:0.85rem; font-weight:600; display:flex; align-items:center; gap:0.35rem}
        .variant-option.active{background:#0f172a; color:#fff; border-color:#0f172a}
        .variant-option span{font-size:0.75rem; color:inherit; opacity:.8}
        .product-price{font-size:1.05rem; font-weight:700}
        .datasheet-link{display:inline-flex; align-items:center; gap:0.4rem; font-size:0.85rem; color:#1d4ed8; margin-top:0.5rem}
        .datasheet-link svg{width:16px; height:16px}
        .cart-alert{margin:0; font-size:0.85rem; font-weight:600}
        .cart-alert.error{color:#d72638}
        .cart-alert.success{color:#0f7a2e}
        .empty-cart{padding:1.25rem; text-align:center; color:#6b7280}
        .detail-panel{box-shadow:0 20px 45px rgba(15,23,42,.15)}
        .detail-breadcrumb{background:linear-gradient(180deg,var(--deep-navy),#0f1f4e); padding:0.3rem 0.8rem; border-radius:999px; color:#fff; display:inline-flex; gap:0.35rem; align-items:center; font-size:0.65rem; letter-spacing:0.08em; text-transform:uppercase}
        .detail-crumb{border:none;background:transparent;color:inherit;font-size:0.65rem;font-weight:600;cursor:pointer;text-transform:uppercase;letter-spacing:0.08em}
        .detail-crumb:hover{text-decoration:underline}
        .detail-main-img{min-height:320px;object-fit:contain}
        .detail-thumbs img{width:64px;height:64px;object-fit:cover;border-radius:0.9rem;border:2px solid transparent;cursor:pointer;background:#f8fafc}
        .detail-thumbs img.active{border-color:var(--accent)}
        .detail-variant-btn{border-radius:999px;border:1px solid rgba(15,61,114,.2);background:#f8fafc;color:#0b1f3a;padding:0.35rem 1rem;font-size:0.85rem;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:0.4rem;transition:background .2s ease,color .2s ease}
        .detail-variant-btn.active{background:var(--deep-navy);color:#fff;border-color:var(--deep-navy)}
        .detail-layout .detail-gallery{border-radius:1.5rem;border:1px solid rgba(15,61,114,.08);padding:1rem;background:#fff}
        @media (max-width:640px){ .detail-layout{grid-template-columns:1fr} }
        @media (max-width:640px){.cart-fab{bottom:1rem; right:1rem; width:calc(100vw - 2rem); justify-content:center}}
    </style>
</head>
<body class="bg-white text-gray-800 scroll-smooth">

<!-- Header / Nav -->
<header class="sticky top-0 z-40 nav-glass text-white">
    <div class="max-w-7xl mx-auto flex items-center justify-between px-4 py-3">
        <div class="flex items-center gap-3">
            <a href="index.html" class="flex items-center gap-3">
                <img src="logo.jpeg" alt="SOFRACOM" class="h-10 w-10 rounded-lg ring-2 ring-white ring-opacity-30">
                <span class="text-xl font-extrabold tracking-wide">SOFRACOM</span>
            </a>
        </div>
        <nav class="hidden md:flex items-center gap-8 text-sm font-medium">
            <a href="index.html#home" class="hover:text-blue-200" data-i18n="nav.home">Home</a>
            <a href="index.html#about" class="hover:text-blue-200" data-i18n="nav.about">About</a>
            <a href="index.html#brands" class="hover:text-blue-200" data-i18n="nav.brands">Brands</a>
            <a href="products.html" class="hover:text-blue-200 underline" data-i18n="nav.products">Products</a>
            <a href="index.html#contact" class="hover:text-blue-200" data-i18n="nav.contact">Contact</a>
        </nav>
        <div class="flex items-center gap-3">
            <input id="searchBox" type="search" class="hidden md:block px-3 py-1.5 rounded-md bg-white bg-opacity-15 placeholder-black text-black border border-white border-opacity-20 focus:outline-none focus:ring-2 focus:ring-blue-200 w-56"
                   placeholder="Search products…">
            <select id="lang" class="px-3 py-1.5 rounded-md bg-white bg-opacity-15 text-black border border-white border-opacity-20 focus:outline-none focus:ring-2 focus:ring-blue-200">
                <option value="en">EN</option>
                <option value="fr">FR</option>
                <option value="ar">AR</option>
            </select>
        </div>
    </div>
</header>

<!-- Hero -->
<section class="relative h-64 flex items-center justify-center text-white">
    <img src="hero.jpeg" class="absolute inset-0 w-full h-full object-cover" alt="">
    <div class="absolute inset-0" style="background:linear-gradient(180deg,rgba(11,32,80,.35),rgba(11,32,80,.75))"></div>
    <div class="relative text-center px-6" data-animate>
        <h1 class="text-3xl sm:text-4xl font-extrabold" data-i18n="hero.title">Products</h1>
        <p class="text-blue-100 mt-2" data-i18n="hero.subtitle">Browse categories → open products</p>
    </div>
</section>

<main class="max-w-7xl mx-auto px-6 py-12">
    <!-- Breadcrumb / Controls -->
    <div class="flex flex-wrap items-center justify-between gap-3 mb-6">
        <nav class="text-sm text-gray-500" id="breadcrumb">
            <a href="index.html" class="hover:underline" data-i18n="crumb.home">Home</a>
            <span class="mx-1">/</span>
            <span class="text-gray-700 font-medium" data-i18n="crumb.products">Products</span>
        </nav>

        <div class="flex items-center gap-3">
            <select id="brandFilter" class="px-3 py-2 rounded-lg border focus:ring-2 focus:ring-blue-200 hidden"></select>
            <button id="backBtn" class="px-3 py-2 rounded-lg border hidden" data-i18n="ui.back">← Back to categories</button>
        </div>
    </div>

    <!-- Categories -->
    <section id="categoriesSection">
        <h2 class="text-2xl font-extrabold mb-4" data-i18n="cats.title">Categories</h2>
        <div id="catGrid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </section>

    <!-- Products -->
    <section id="productsSection" class="hidden">
        <div class="flex items-end justify-between gap-4">
            <div>
                <h2 id="catTitle" class="text-2xl font-extrabold"></h2>
                <p id="catDesc" class="text-gray-600 mt-1"></p>
            </div>
        </div>
        <div class="mt-6 grid sm:grid-cols-2 lg:grid-cols-3 gap-6" id="prodGrid"></div>
    </section>
    <section id="productDetailSection" class="hidden mt-10">
        <div class="detail-panel rounded-3xl border border-gray-200 bg-white p-6 shadow-2xl">
            <div class="detail-header flex items-center justify-between gap-4">
                <div id="detailBreadcrumb" class="detail-breadcrumb text-xs uppercase tracking-wide"></div>
                <button id="productDetailClose" type="button" class="detail-close text-sm text-gray-500 border border-gray-200 rounded-full px-3 py-1 hover:border-gray-400 hover:text-gray-900 transition">Close</button>
            </div>
            <div class="detail-layout grid gap-6 lg:grid-cols-2 mt-6">
                <div class="detail-gallery">
                    <img id="detailMainImage" src="assets/placeholder-prod.jpg" alt="Product image" class="detail-main-img block w-full rounded-2xl border border-gray-200 bg-gray-50 object-contain">
                    <div id="detailThumbs" class="detail-thumbs mt-4 flex flex-wrap gap-3"></div>
                </div>
                <div class="detail-meta flex flex-col gap-4">
                    <div>
                        <p id="detailCategoryName" class="text-xs text-gray-500"></p>
                        <h2 id="detailTitle" class="text-3xl font-semibold text-gray-900 leading-tight"></h2>
                        <p id="detailBrand" class="text-sm text-gray-500 mt-1"></p>
                    </div>
                    <div id="detailUsage" class="flex flex-wrap gap-2"></div>
                    <div class="detail-price-row flex flex-wrap items-center gap-3">
                        <span id="detailPrice" class="text-3xl font-bold text-gray-900"></span>
                        <span id="detailStockBadge" class="stock-badge"></span>
                    </div>
                    <div id="detailVariants" class="detail-variants flex flex-wrap gap-2"></div>
                    <p id="detailDescription" class="text-sm text-gray-700 leading-relaxed"></p>
                    <div id="detailDatasheet" class="text-sm"></div>
                    <button id="detailAddBtn" type="button" class="w-full rounded-2xl bg-blue-600 px-4 py-3 text-sm font-semibold text-white shadow hover:bg-blue-700 transition">Add to cart</button>
                    <p id="detailStatus" class="quote-status hidden" aria-live="polite"></p>
                </div>
            </div>
        </div>
    </section>
</main>

<button id="cartFab" class="cart-fab" type="button">
    <span data-i18n="ui.cart">Cart</span>
    <span class="px-2 py-1 rounded-full bg-white/15 text-sm font-semibold" id="cartCount">0</span>
</button>

<div id="cartOverlay" class="cart-overlay"></div>

<aside id="cartDrawer" class="cart-drawer" aria-hidden="true" aria-labelledby="cartTitle">
    <div class="cart-header">
        <div>
            <h3 id="cartTitle" class="text-lg font-semibold text-gray-900" data-i18n="cart.title">Your order</h3>
            <p class="text-sm text-gray-500" data-i18n="cart.subtitle">Review items then confirm your details.</p>
        </div>
        <button id="cartClose" type="button" aria-label="Close cart" class="text-2xl leading-none text-gray-500 hover:text-gray-800">×</button>
    </div>
    <div class="cart-body" id="cartItems"></div>
    <div class="cart-summary">
        <div class="cart-summary-row">
            <span data-i18n="cart.total">Total</span>
            <span id="cartTotal">0 TND</span>
        </div>
        <p id="cartAlert" class="cart-alert" role="status"></p>
    </div>
    <form id="checkoutForm" class="cart-form" novalidate>
        <label>
            <span data-i18n="cart.name">Full name</span>
            <input type="text" name="name" autocomplete="name" required minlength="2" placeholder="John Doe" />
        </label>
        <label>
            <span data-i18n="cart.phone">Phone</span>
            <input type="tel" name="phone" autocomplete="tel" required minlength="6" placeholder="+216 00 000 000" />
        </label>
        <label>
            <span data-i18n="cart.address">Delivery address</span>
            <textarea name="address" rows="2" required placeholder="Marina Monastir, dock 5"></textarea>
        </label>
        <label>
            <span data-i18n="cart.note">Notes (optional)</span>
            <textarea name="notes" rows="2" placeholder="Preferred delivery time, marina berth, etc."></textarea>
        </label>
        <button id="cartSubmitBtn" type="submit" class="cart-submit" data-i18n="cart.submit">Send order</button>
    </form>
</aside>

<!-- Footer -->
<footer class="bg-blue-950 text-blue-100 mt-16">
    <div class="max-w-7xl mx-auto px-6 py-6 text-sm opacity-80 flex items-center justify-between">
        <span>© <span id="y"></span> SOFRACOM</span>
        <a href="#" class="hover:underline">Back to top</a>
    </div>
</footer>

<!-- Embedded demo data (used offline / file:// fallback) -->
<script id="productsData" type="application/json">
    {
        "categories": [
            {
                "name": "Antifouling & Coatings",
                "slug": "antifouling-coatings",
                "image": "assets/bosch.png",
                "description": "Bottom paints, primers, and topcoats for local waters.",
                "products": [
                    {"title":"Jotun SeaForce 30","image":"assets/bosch.png","description":"Self-polishing antifouling for sailing yachts and motorboats.","brand":"JOTUN","usage":["Antifouling","Warm waters","Self-polishing"],"price":380,"stock":"in"},
                    {"title":"Hempel Mille NCT","image":"assets/bosch.png","description":"High-performance antifouling with advanced binder.","brand":"HEMPEL","usage":["Antifouling","Long-lasting","Easy apply"],"price":420,"stock":"in"}
                ]
            },
            {
                "name": "Sealants & Adhesives",
                "slug": "sealants-adhesives",
                "image": "assets/bosch.png",
                "description": "Marine sealants for deck hardware, teak, hatches, and glazing.",
                "products": [
                    {"title":"Sika 291i","image":"assets/bosch.png","description":"Multi-purpose marine sealant/adhesive for general use.","brand":"SIKA","usage":["Deck hardware","General bonding","Flexible"],"price":65,"stock":"in"},
                    {"title":"Sika 295 UV","image":"assets/bosch.png","description":"UV-resistant adhesive for organic glass (PMMA/PC).","brand":"SIKA","usage":["Windows","UV-resistant","Elastic"],"price":89,"stock":"in"}
                ]
            },
            {
                "name": "Oils, Filters & Batteries",
                "slug": "oils-filters-batteries",
                "image": "assets/bosch.png",
                "description": "Engine oils, filters and reliable onboard power.",
                "products": [
                    {"title":"Shell Rimula R4 15W-40","image":"assets/bosch.png","description":"Heavy-duty engine oil for marine diesel.","brand":"SHELL","usage":["Engine","Protection"],"price":120,"stock":"in"},
                    {"title":"VARTA Blue Dynamic 75Ah","image":"assets/bosch.png","description":"Marine battery with strong cold cranking performance.","brand":"VARTA","usage":["Battery","Electrical"],"price":780,"stock":"in"}
                ]
            }
        ]
    }
</script>

<script>
    // Sticky header solid on scroll
    const header = document.querySelector('header');
    addEventListener('scroll', () => {
        if (scrollY > 40) header.classList.add('nav-solid'); else header.classList.remove('nav-solid');
    });
    document.getElementById('y').textContent = new Date().getFullYear();

    // Intersection reveal
    const io = new IntersectionObserver((es)=> es.forEach(e=>{ if(e.isIntersecting){e.target.classList.add('in-view'); io.unobserve(e.target);} }), {threshold:.15});
    document.querySelectorAll('[data-animate]').forEach(el=>io.observe(el));

    // Tilt
    function tiltify(card){
        const r=12;
        function move(e){ const b=card.getBoundingClientRect(), px=(e.clientX-b.left)/b.width, py=(e.clientY-b.top)/b.height; card.style.transform=`rotateX(${(0.5-py)*r}deg) rotateY(${(px-0.5)*r}deg)`;}
        function reset(){ card.style.transform='rotateX(0) rotateY(0)';}
        card.addEventListener('mousemove',move); card.addEventListener('mouseleave',reset);
    }

    // ==== Data load (fetch + fallback to embedded JSON for file://) ====
    const DATA_URL = './assets/data/products.json';
    const catGrid = document.getElementById('catGrid');
    const prodGrid = document.getElementById('prodGrid');
    const categoriesSection = document.getElementById('categoriesSection');
    const productsSection = document.getElementById('productsSection');
    const backBtn = document.getElementById('backBtn');
    const brandFilter = document.getElementById('brandFilter');
    const searchBox = document.getElementById('searchBox');
    const catTitle = document.getElementById('catTitle');
    const catDesc = document.getElementById('catDesc');
    const breadcrumb = document.getElementById('breadcrumb');
    const langSel = document.getElementById('lang');

    const CART_KEY = 'sofracom.cart.v1';
    const PRODUCT_INDEX = {};
    const cartFab = document.getElementById('cartFab');
    const cartOverlay = document.getElementById('cartOverlay');
    const cartDrawer = document.getElementById('cartDrawer');
    const cartItemsEl = document.getElementById('cartItems');
    const cartCountEl = document.getElementById('cartCount');
    const cartTotalEl = document.getElementById('cartTotal');
    const cartAlert = document.getElementById('cartAlert');
    const cartCloseBtn = document.getElementById('cartClose');
    const cartForm = document.getElementById('checkoutForm');
    const cartSubmitBtn = document.getElementById('cartSubmitBtn');
    const detailSection = document.getElementById('productDetailSection');
    const detailBreadcrumb = document.getElementById('detailBreadcrumb');
    const detailMainImage = document.getElementById('detailMainImage');
    const detailThumbs = document.getElementById('detailThumbs');
    const detailTitle = document.getElementById('detailTitle');
    const detailBrand = document.getElementById('detailBrand');
    const detailCategoryName = document.getElementById('detailCategoryName');
    const detailUsage = document.getElementById('detailUsage');
    const detailPrice = document.getElementById('detailPrice');
    const detailVariants = document.getElementById('detailVariants');
    const detailDescription = document.getElementById('detailDescription');
    const detailDatasheet = document.getElementById('detailDatasheet');
    const detailStockBadge = document.getElementById('detailStockBadge');
    const detailAddBtn = document.getElementById('detailAddBtn');
    const detailStatus = document.getElementById('detailStatus');
    const detailCloseBtn = document.getElementById('productDetailClose');

    let STORE = null, activeCat = null, filtered = [];
    let currentLang = 'en';
    let cart = [];
    let detailActiveProductId = null;
    let detailActiveVariantIndex = 0;

    function loadCart(){
        if (typeof localStorage === 'undefined') return [];
        try {
            const raw = localStorage.getItem(CART_KEY);
            if (!raw) return [];
            const parsed = JSON.parse(raw);
            if (!Array.isArray(parsed)) return [];
            return parsed.map(item => ({
                ...item,
                quantity: Number.isFinite(item.quantity) && item.quantity > 0
                    ? Math.max(1, Math.trunc(item.quantity))
                    : 1,
            }));
        } catch (error) {
            console.warn('cart: failed to read storage', error);
            return [];
        }
    }

    function saveCart(){
        if (typeof localStorage === 'undefined') return;
        try {
            localStorage.setItem(CART_KEY, JSON.stringify(cart));
        } catch (error) {
            console.warn('cart: failed to persist', error);
        }
    }

    function calculateCartTotal(){
        return cart.reduce((total, item) => {
            if (typeof item.price === 'number') {
                return total + item.price * item.quantity;
            }
            return total;
        }, 0);
    }

    function updateCartCount(){
        const count = cart.reduce((sum, item) => sum + item.quantity, 0);
        cartCountEl.textContent = count;
        cartFab.dataset.count = count;
    }

    function getCartQuantity(id){
        const item = cart.find(entry => entry.id === id);
        return item ? item.quantity : 0;
    }

    function showCartAlert(message = '', type = ''){
        cartAlert.textContent = message;
        cartAlert.classList.remove('error', 'success');
        if (message && type) {
            cartAlert.classList.add(type);
        }
    }

    function renderCart(){
        const total = calculateCartTotal();
        if (!cart.length){
            cartItemsEl.innerHTML = `<div class="empty-cart" data-i18n="cart.empty">${getLabel('cart.empty')}</div>`;
            cartTotalEl.textContent = formatPrice(0);
            cartSubmitBtn.disabled = true;
            return;
        }

        cartSubmitBtn.disabled = false;
        cartItemsEl.innerHTML = cart.map(item => {
            const lineTotal = typeof item.price === 'number'
                ? formatPrice(item.price * item.quantity)
                : getLabel('cart.contact');
            const unitPrice = typeof item.price === 'number'
                ? `<span class="text-xs text-gray-500">${formatPrice(item.price)} / ${getLabel('cart.unit')}</span>`
                : '';
            return `
        <div class="cart-item" data-id="${item.id}">
            <img src="${item.image}" alt="${item.title}">
            <div>
                <div class="flex items-start justify-between gap-2">
                    <div>
                        <p class="cart-item-title">${item.title}</p>
                        <p class="text-xs text-gray-500">${item.variantLabel ? item.variantLabel + ' · ' : ''}${item.category || ''}</p>
                    </div>
                    <button type="button" class="text-sm text-red-500 hover:text-red-600" data-action="remove" aria-label="${getLabel('cart.remove')}">×</button>
                </div>
                <div class="mt-3 flex items-center justify-between gap-3">
                    <div class="cart-qty" aria-label="${getLabel('cart.quantity')}">
                        <button type="button" data-action="decrement" aria-label="${getLabel('cart.decrease')}">−</button>
                        <input type="number" min="1" step="1" value="${item.quantity}" data-action="quantity" aria-label="${getLabel('cart.quantityInput')}">
                        <button type="button" data-action="increment" aria-label="${getLabel('cart.increase')}">+</button>
                    </div>
                    <div class="text-right">
                        <div class="font-semibold price">${lineTotal}</div>
                        ${unitPrice}
                    </div>
                </div>
            </div>
        </div>`;
        }).join('');

        cartTotalEl.textContent = total > 0 ? formatPrice(total) : getLabel('cart.contact');
    }

    function openCart(){
        cartDrawer.classList.add('open');
        cartDrawer.setAttribute('aria-hidden', 'false');
        cartOverlay.classList.add('active');
    }

    function closeCart(){
        cartDrawer.classList.remove('open');
        cartDrawer.setAttribute('aria-hidden', 'true');
        cartOverlay.classList.remove('active');
    }

function addToCartById(id, quantity = 1, variantIndex = 0){
    const product = PRODUCT_INDEX[id];
    if (!product){
        showCartAlert(getLabel('cart.notFound'), 'error');
        return;
    }
    if (product.stock === 'out'){
        showCartAlert(getLabel('cart.outOfStock'), 'error');
        return;
    }

        const variant = Array.isArray(product.variants) ? product.variants[variantIndex] : null;
        const unitPrice = variant && Number.isFinite(variant.price) ? variant.price : product.price;
        const variantLabel = variant ? variant.label : '';
        const image = Array.isArray(product.images) && product.images[0]
            ? product.images[0]
            : product.image || 'assets/placeholder-prod.jpg';
        const existing = cart.find(item => item.id === id && item.variantLabel === variantLabel);
        if (existing){
            existing.quantity += quantity;
        } else {
            cart.push({
                id,
                title: product.title,
                price: Number.isFinite(unitPrice) ? unitPrice : null,
                quantity: Math.max(1, quantity),
                image,
                variantLabel,
                category: product.categoryName || '',
            });
        }

        saveCart();
        renderCart();
        updateCartCount();
        showCartAlert(getLabel('cart.added'), 'success');
    }

    function updateCartQuantity(id, value){
        const item = cart.find(entry => entry.id === id);
        if (!item) return;
        const next = Number.isFinite(value) ? Math.trunc(value) : 1;
        if (next <= 0){
            removeFromCart(id);
            return;
        }
        item.quantity = Math.max(1, next);
        saveCart();
        renderCart();
        updateCartCount();
    }

    function removeFromCart(id){
        cart = cart.filter(entry => entry.id !== id);
        saveCart();
        renderCart();
        updateCartCount();
        showCartAlert(getLabel('cart.removed'), 'success');
    }

    cart = loadCart();
    updateCartCount();

    cartFab.addEventListener('click', () => {
        renderCart();
        showCartAlert('', '');
        openCart();
    });
    cartOverlay.addEventListener('click', closeCart);
    cartCloseBtn.addEventListener('click', closeCart);
    document.addEventListener('keydown', event => {
        if (event.key === 'Escape') closeCart();
    });

    cartItemsEl.addEventListener('click', event => {
        const action = event.target.dataset.action;
        if (!action) return;
        const row = event.target.closest('[data-id]');
        if (!row) return;
        const id = row.dataset.id;
        if (action === 'remove'){
            removeFromCart(id);
        } else if (action === 'increment'){
            updateCartQuantity(id, getCartQuantity(id) + 1);
        } else if (action === 'decrement'){
            updateCartQuantity(id, getCartQuantity(id) - 1);
        }
    });

    cartItemsEl.addEventListener('change', event => {
        if (event.target.dataset.action !== 'quantity') return;
        const row = event.target.closest('[data-id]');
        if (!row) return;
        const id = row.dataset.id;
        const value = Number.parseInt(event.target.value, 10);
        if (!Number.isFinite(value)){
            event.target.value = getCartQuantity(id);
            return;
        }
        updateCartQuantity(id, value);
    });

    cartForm.addEventListener('submit', handleCheckoutSubmit);

    async function handleCheckoutSubmit(event){
        event.preventDefault();
        if (!cart.length){
            showCartAlert(getLabel('cart.empty'), 'error');
            return;
        }

        const formData = new FormData(cartForm);
        const customer = {
            name: (formData.get('name') || '').trim(),
            phone: (formData.get('phone') || '').trim(),
            address: (formData.get('address') || '').trim(),
            notes: (formData.get('notes') || '').trim(),
        };

        if (customer.name.length < 2){
            showCartAlert(getLabel('cart.nameRequired'), 'error');
            return;
        }
        if (customer.phone.length < 6){
            showCartAlert(getLabel('cart.phoneRequired'), 'error');
            return;
        }
        if (customer.address.length < 6){
            showCartAlert(getLabel('cart.addressRequired'), 'error');
            return;
        }

        const payload = {
            customer,
            items: cart.map(item => ({
                id: item.id,
                title: item.title,
                price: item.price,
                quantity: item.quantity,
                image: item.image,
                category: item.category,
            })),
            total: calculateCartTotal(),
            currency: 'TND',
        };

        const defaultLabel = cartSubmitBtn.textContent;
        cartSubmitBtn.disabled = true;
        cartSubmitBtn.textContent = getLabel('cart.sending');
        showCartAlert('', '');

        try {
            const response = await fetch('/api/create-order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });
            const result = await response.json().catch(() => ({ ok: false }));
            if (!response.ok || !result.ok){
                throw new Error(result.error || `HTTP ${response.status}`);
            }
            cart = [];
            saveCart();
            renderCart();
            updateCartCount();
            cartForm.reset();
            showCartAlert(getLabel('cart.success'), 'success');
        } catch (error){
            console.error('order submit failed', error);
            showCartAlert(getLabel('cart.error'), 'error');
        } finally {
            cartSubmitBtn.disabled = false;
            cartSubmitBtn.textContent = defaultLabel;
        }
    }

    function getEmbeddedJSON(){
        try { const el = document.getElementById('productsData'); return el ? JSON.parse(el.textContent) : null; }
        catch(e){ return null; }
    }

    (async () => {
        try {
            const r = await fetch(DATA_URL, {cache:'no-cache'});
            if (!r.ok) throw new Error('HTTP '+r.status);
            STORE = await r.json();
        } catch (e) {
            STORE = getEmbeddedJSON();
            if (!STORE){
                catGrid.innerHTML = `<div class="text-red-600">Failed to load products data.</div>`;
                console.error(e);
                return;
            }
        }
        renderCategories(STORE.categories);
        const p = new URLSearchParams(location.search);
        const slug = p.get('cat'); if (slug) openCategory(slug);
        applyLang((localStorage.getItem('lang')||'en')); // sync i18n once data is drawn
    })();

    function slugify(s){return s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');}

    function renderCategories(cats){
        categoriesSection.classList.remove('hidden');
        productsSection.classList.add('hidden');
        backBtn.classList.add('hidden'); brandFilter.classList.add('hidden'); searchBox.classList.add('hidden');

        breadcrumb.innerHTML = `<a href="index.html" class="hover:underline" data-i18n="crumb.home">Home</a> <span class="mx-1">/</span> <span class="text-gray-700 font-medium" data-i18n="crumb.products">Products</span>`;

        catGrid.innerHTML = cats.map(c => {
            const s = c.slug || slugify(c.name);
            const img = c.image || 'assets/placeholder-cat.jpg';
            return `
            <button data-cat="${s}" class="tilt group text-left bg-white rounded-2xl overflow-hidden shadow hover:shadow-xl transform transition">
              <div class="layer">
                <img src="${img}" alt="${c.name}" class="card-img w-full">
                <div class="p-4">
                  <h3 class="text-lg font-semibold text-gray-900 group-hover:text-blue-900">${c.name}</h3>
                  ${c.description ? `<p class="text-sm text-gray-600 mt-1">${c.description}</p>`:''}
                </div>
              </div>
            </button>`;
        }).join('');
        catGrid.querySelectorAll('.tilt').forEach(tiltify);
        catGrid.querySelectorAll('[data-cat]').forEach(btn => btn.addEventListener('click', () => openCategory(btn.dataset.cat)));
        hideProductDetail();
    }

    function hideProductDetail(){
        detailActiveProductId = null;
        detailActiveVariantIndex = 0;
        detailSection?.classList.add('hidden');
    }

    detailBreadcrumb?.addEventListener('click', event => {
        const target = event.target.closest('[data-target]');
        if (!target) return;
        const action = target.dataset.target;
        if (!action) return;
        hideProductDetail();
        if (action === 'home') {
            window.location.href = 'index.html';
            return;
        }
        if (action === 'products') {
            renderCategories(STORE.categories);
            history.replaceState(null, '', 'products.html');
            return;
        }
        if (action === 'category') {
            const slug = target.dataset.cat;
            if (slug) openCategory(slug);
        }
    });
    detailCloseBtn?.addEventListener('click', hideProductDetail);

    function openCategory(slug){
        const cat = STORE.categories.find(c => (c.slug || slugify(c.name)) === slug);
        if (!cat){ alert('Category not found'); return; }
        activeCat = cat;
        hideProductDetail();

        categoriesSection.classList.add('hidden');
        productsSection.classList.remove('hidden');
        backBtn.classList.remove('hidden'); brandFilter.classList.remove('hidden'); searchBox.classList.remove('hidden');

        breadcrumb.innerHTML = `<a href="index.html" class="hover:underline" data-i18n="crumb.home">Home</a> <span class="mx-1">/</span>
                            <a href="products.html" class="hover:underline" data-i18n="crumb.products">Products</a> <span class="mx-1">/</span>
                            <span class="text-gray-700 font-medium">${cat.name}</span>`;

        catTitle.textContent = cat.name;
        catDesc.textContent = cat.description || '';

        const brands = Array.from(new Set(cat.products.map(p=>p.brand).filter(Boolean))).sort();
        brandFilter.innerHTML = `<option value="">All brands</option>` + brands.map(b=>`<option>${b}</option>`).join('');

        filtered = cat.products.slice();
        searchBox.value=''; brandFilter.value='';
        renderProducts();
        history.replaceState(null,'',`?cat=${encodeURIComponent(cat.slug || slugify(cat.name))}`);
    }

    function renderProducts(){
        const list = filtered;
        Object.keys(PRODUCT_INDEX).forEach(key => delete PRODUCT_INDEX[key]);

        if (!list.length){
            prodGrid.innerHTML = `<div class="col-span-full text-gray-500" data-i18n="ui.none">${getLabel('ui.none')}</div>`;
            return;
        }

        const catSlug = activeCat ? (activeCat.slug || slugify(activeCat.name)) : 'catalogue';
        prodGrid.innerHTML = list.map((p, idx) => {
            const id = `${catSlug}::${slugify(p.title || 'item')}-${idx}`;
            const numericPrice = typeof p.price === 'number' ? p.price : Number(p.price);
            const images = Array.isArray(p.images)
                ? p.images
                : p.image
                    ? [p.image]
                    : ['assets/placeholder-prod.jpg'];
            const variantsRaw = Array.isArray(p.variants) ? p.variants : [];
            const variants = variantsRaw
                .map(variant => ({
                    label: variant.label || 'Option',
                    price: Number.isFinite(Number(variant.price)) ? Number(variant.price) : null,
                }))
                .filter(v => v.price !== null);
            PRODUCT_INDEX[id] = {
                ...p,
                price: Number.isFinite(numericPrice) ? numericPrice : null,
                images,
                variants,
                datasheet: p.datasheet || '',
                categorySlug: catSlug,
                categoryName: activeCat ? activeCat.name : '',
                stock: p.stock === 'out' ? 'out' : 'in',
                selectedVariantIndex: 0,
            };
            return productCard(activeCat, p, id);
        }).join('');

        prodGrid.querySelectorAll('.tilt').forEach(tiltify);
        wireVariantControls();
        wireDescriptionToggles();
        wireDetailButtons();
        prodGrid.querySelectorAll('.product-add').forEach(btn => {
            btn.addEventListener('click', event => {
                const id = event.currentTarget.dataset.productId;
                const variantIndex = Number(event.currentTarget.dataset.variantIndex) || 0;
                addToCartById(id, 1, variantIndex);
                openCart();
            });
        });
    }

    function wireVariantControls() {
        prodGrid.querySelectorAll('.product-variants').forEach(container => {
            const card = container.closest('.product-card');
            if (!card) return;
            const productId = card.dataset.productId;
            const product = PRODUCT_INDEX[productId];
            if (!product) return;
            const priceEl = card.querySelector('[data-product-price]');
            const addBtn = card.querySelector('.product-add');
            container.querySelectorAll('.variant-option').forEach(btn => {
                btn.addEventListener('click', () => {
                    const index = Number(btn.dataset.variantIndex);
                    product.selectedVariantIndex = index;
                    container.querySelectorAll('.variant-option').forEach(el => el.classList.remove('active'));
                    btn.classList.add('active');
                    const variant = product.variants[index];
                    if (priceEl && variant) {
                        priceEl.textContent = formatPrice(variant.price);
                    }
                    if (addBtn) {
                        addBtn.dataset.variantIndex = index;
                    }
                });
            });
        });
    }

    function wireDescriptionToggles(){
        prodGrid.querySelectorAll('.read-more-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const card = btn.closest('.product-card');
                const description = card?.querySelector('.product-description');
                if (!description) return;
                const expanded = description.classList.toggle('expanded');
                btn.textContent = expanded ? 'Show less' : 'Read more';
            });
        });
    }

    function setDetailBreadcrumb(product){
        if (!detailBreadcrumb) return;
        const parts = [
            `<button type="button" class="detail-crumb" data-target="home">Home</button>`,
            `<button type="button" class="detail-crumb" data-target="products">Products</button>`,
        ];
        if (product.categoryName) {
            const catSlug = product.categorySlug || slugify(product.categoryName);
            parts.push(`<button type="button" class="detail-crumb" data-target="category" data-cat="${catSlug}">${product.categoryName}</button>`);
        }
        detailBreadcrumb.innerHTML = parts.map((part, idx) => idx ? `<span class="mx-1 text-white/70">/</span>${part}` : part).join('');
    }

    function renderDetailVariants(product){
        detailVariants.innerHTML = '';
        const variants = Array.isArray(product.variants) ? product.variants : [];
        if (!variants.length){
            const fallback = Number.isFinite(product.price) ? product.price : null;
            detailPrice.textContent = fallback !== null ? formatPrice(fallback) : getLabel('cart.contact');
            detailActiveVariantIndex = 0;
            return;
        }
        variants.forEach((variant, idx) => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = `detail-variant-btn${idx === 0 ? ' active' : ''}`;
            btn.dataset.index = idx;
            btn.innerHTML = `<span>${variant.label}</span><span>${formatPrice(variant.price)}</span>`;
            btn.addEventListener('click', () => {
                detailVariants.querySelectorAll('button').forEach(el => el.classList.remove('active'));
                btn.classList.add('active');
                detailActiveVariantIndex = idx;
                detailPrice.textContent = formatPrice(variant.price);
            });
            detailVariants.appendChild(btn);
        });
        detailActiveVariantIndex = 0;
        detailPrice.textContent = formatPrice(variants[0].price);
    }

    function openProductDetail(productId){
        const product = PRODUCT_INDEX[productId];
        if (!product) return;
        detailActiveProductId = productId;
        detailSection?.classList.remove('hidden');
        const images = Array.isArray(product.images) && product.images.length ? product.images : [product.image || 'assets/placeholder-prod.jpg'];
        detailMainImage.src = images[0];
        detailThumbs.innerHTML = '';
        images.forEach((src, idx) => {
            const thumb = document.createElement('img');
            thumb.src = src;
            thumb.alt = product.title || 'Product';
            if (idx === 0) thumb.classList.add('active');
            thumb.addEventListener('click', () => {
                detailMainImage.src = src;
                detailThumbs.querySelectorAll('img').forEach(img => img.classList.remove('active'));
                thumb.classList.add('active');
            });
            detailThumbs.appendChild(thumb);
        });
        detailTitle.textContent = product.title || '';
        detailBrand.textContent = product.brand ? `Brand: ${product.brand}` : '';
        detailCategoryName.textContent = product.categoryName || '';
        detailUsage.innerHTML = (Array.isArray(product.usage) ? product.usage : []).map(tag => `<span class="tag text-xs">${tag}</span>`).join('');
        detailDescription.textContent = product.description || '';
        detailDatasheet.innerHTML = product.datasheet
            ? `<a class="datasheet-link" href="${product.datasheet}" target="_blank" rel="noopener"><span>Download datasheet</span></a>`
            : '';
        detailStockBadge.innerHTML = `<span class="stock-badge ${product.stock === 'out' ? 'stock-badge--out' : 'stock-badge--in'}">${getLabel(product.stock === 'out' ? 'ui.outStock' : 'ui.inStock')}</span>`;
        detailAddBtn.disabled = product.stock === 'out';
        detailStatus?.classList.add('hidden');
        renderDetailVariants(product);
        setDetailBreadcrumb(product);
        detailSection?.scrollIntoView({behavior:'smooth', block:'start'});
    }

    function wireDetailButtons(){
        prodGrid.querySelectorAll('.product-detail-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                openProductDetail(btn.dataset.detail);
            });
        });
    }

    detailAddBtn?.addEventListener('click', () => {
        if (!detailActiveProductId) return;
        addToCartById(detailActiveProductId, 1, detailActiveVariantIndex);
        openCart();
    });

    function getLabel(key){
        const dictionaries = (typeof I18N !== 'undefined' && I18N) ? I18N : { en: {} };
        const dict = dictionaries[currentLang] || dictionaries.en || {};
        return dict[key] || (dictionaries.en ? dictionaries.en[key] : key) || key;
    }

    function productCard(category, p, id){
        const heroImage = (Array.isArray(p.images) && p.images[0]) || p.image || 'assets/placeholder-prod.jpg';
        const usage = Array.isArray(p.usage) ? p.usage.map(u=>`<span class="px-2 py-1 rounded tag text-xs">${u}</span>`).join(' ') : '';
        const stock = (p.stock === 'out') ? 'out' : 'in';
        const stockKey = stock === 'in' ? 'ui.inStock' : 'ui.outStock';
        const stockBadge = `<span class="stock-badge ${stock === 'in' ? 'stock-badge--in' : 'stock-badge--out'}" data-i18n="${stockKey}">${getLabel(stockKey)}</span>`;
        const stateClass = stock === 'out' ? ' product-out' : '';
        const brandLabel = getLabel('ui.brand');
        const buttonLabel = stock === 'out' ? getLabel('ui.outStock') : getLabel('ui.addToCart');
        const description = (p.description || '').replace(/\n/g, ' ');
        const variants = Array.isArray(p.variants) ? p.variants : [];
        const fallbackPrice = Number.isFinite(Number(p.price)) ? Number(p.price) : null;
        const initialVariant = variants.length ? variants[0] : null;
        const priceValue = initialVariant ? initialVariant.price : fallbackPrice;
        const priceMarkup = priceValue !== null ? `<span class="product-price" data-product-price>${formatPrice(priceValue)}</span>` : `<span class="product-price" data-product-price>${getLabel('cart.contact')}</span>`;
        const variantMarkup = variants.length
            ? `<div class="product-variants" data-product-id="${id}">
                ${variants.map((variant, idx) => `<button type="button" class="variant-option${idx===0?' active':''}" data-variant-index="${idx}">
                    ${variant.label} <span>${formatPrice(variant.price)}</span>
                </button>`).join('')}
              </div>`
            : '';
        const datasheetMarkup = p.datasheet
            ? `<a class="datasheet-link" href="${p.datasheet}" target="_blank" rel="noopener">
                 <span>Download datasheet</span>
               </a>`
            : '';
        const button = `<button type="button" class="product-add mt-4 inline-flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-blue-600 text-white text-sm font-semibold shadow transition hover:bg-blue-700 disabled:opacity-60 disabled:cursor-not-allowed" data-product-id="${id}" data-variant-index="0" ${stock === 'out' ? 'disabled' : ''}>${buttonLabel}</button>`;
        return `
      <article class="tilt product-card${stateClass}" data-product-id="${id}">
        <div class="layer">
          <img src="${heroImage}" alt="${p.title}" class="card-img w-full" loading="lazy">
          <div class="p-4 flex flex-col gap-2">
            <div class="flex items-center justify-between">
              <h3 class="text-lg font-semibold text-gray-900">${p.title}</h3>
              ${stockBadge}
            </div>
            <p class="text-xs text-gray-500"><span data-i18n="ui.brand">${brandLabel}</span>: <b>${p.brand||'—'}</b></p>
            <p class="product-description clamped" data-product-id="${id}">${description}</p>
            <button type="button" class="read-more-btn" data-product-id="${id}">Read more</button>
            ${datasheetMarkup}
            <div class="mt-2 flex flex-wrap gap-2">${usage}</div>
            <div class="mt-3 product-price-row flex flex-wrap items-center justify-between gap-2">
              ${priceMarkup}
              ${variantMarkup}
            </div>
            <div class="product-actions">
              ${button}
              <button type="button" class="product-detail-btn text-blue-600 font-semibold" data-detail="${id}">View details</button>
            </div>
          </div>
        </div>
      </article>`;
    }

    function formatPrice(v){
        try { return new Intl.NumberFormat('fr-TN',{style:'currency',currency:'TND'}).format(v); }
        catch(e){ return v + ' TND'; }
    }

    // Filters
    brandFilter.addEventListener('change', applyFilters);
    searchBox.addEventListener('input', debounce(applyFilters, 120));
    backBtn.addEventListener('click', ()=>{ history.replaceState(null,'','products.html'); renderCategories(STORE.categories); applyLang((localStorage.getItem('lang')||'en')); hideProductDetail(); });

    function applyFilters(){
        const q = (searchBox.value||'').toLowerCase();
        const b = brandFilter.value||'';
        let list = activeCat.products.slice();
        if (b) list = list.filter(p=> (p.brand||'').toLowerCase() === b.toLowerCase());
        if (q) list = list.filter(p =>
            (p.title||'').toLowerCase().includes(q) ||
            (p.description||'').toLowerCase().includes(q) ||
            (p.brand||'').toLowerCase().includes(q) ||
            (Array.isArray(p.usage) ? p.usage.join(' ').toLowerCase().includes(q) : false)
        );
        filtered = list;
        renderProducts();
    }

    function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

    // ======= i18n (EN/FR/AR + RTL) =======
    const I18N = {
        en:{
            'nav.home':'Home','nav.about':'About','nav.brands':'Brands','nav.products':'Products','nav.contact':'Contact',
            'hero.title':'Products','hero.subtitle':'Browse categories → open products',
            'crumb.home':'Home','crumb.products':'Products',
            'cats.title':'Categories','ui.back':'← Back to categories','ui.allBrands':'All brands','ui.none':'No products found.','ui.brand':'Brand',
            'ui.search':'Search products…','ui.inStock':'In stock','ui.outStock':'Out of stock','ui.addToCart':'Add to cart','ui.cart':'Cart',
            'cart.title':'Your order','cart.subtitle':'Review items then confirm your details.','cart.total':'Total','cart.name':'Full name','cart.phone':'Phone',
            'cart.address':'Delivery address','cart.note':'Notes (optional)','cart.submit':'Send order','cart.empty':'Your cart is empty.','cart.contact':'Contact us',
            'cart.unit':'unit','cart.remove':'Remove item','cart.quantity':'Quantity','cart.decrease':'Decrease quantity','cart.increase':'Increase quantity',
            'cart.quantityInput':'Quantity value','cart.added':'Added to cart','cart.removed':'Removed from cart','cart.outOfStock':'Out of stock',
            'cart.notFound':'Product no longer available','cart.nameRequired':'Enter a valid name to continue','cart.phoneRequired':'Enter a valid phone number',
            'cart.addressRequired':'Enter a delivery address','cart.sending':'Sending…','cart.success':'Order received! We will contact you shortly.',
            'cart.error':'Submission failed. Please try again or contact us.'
        },
        fr:{
            'nav.home':'Accueil','nav.about':'À propos','nav.brands':'Marques','nav.products':'Produits','nav.contact':'Contact',
            'hero.title':'Produits','hero.subtitle':'Parcourez les catégories → ouvrez les produits',
            'crumb.home':'Accueil','crumb.products':'Produits',
            'cats.title':'Catégories','ui.back':'← Retour aux catégories','ui.allBrands':'Toutes les marques','ui.none':'Aucun produit trouvé.','ui.brand':'Marque',
            'ui.search':'Rechercher des produits…','ui.inStock':'En stock','ui.outStock':'En rupture','ui.addToCart':'Ajouter au panier','ui.cart':'Panier',
            'cart.title':'Votre commande','cart.subtitle':'Vérifiez les articles puis confirmez vos coordonnées.','cart.total':'Total','cart.name':'Nom complet',
            'cart.phone':'Téléphone','cart.address':'Adresse de livraison','cart.note':'Notes (optionnel)','cart.submit':'Envoyer la commande',
            'cart.empty':'Votre panier est vide.','cart.contact':'Nous contacter','cart.unit':'unité','cart.remove':'Retirer l’article','cart.quantity':'Quantité',
            'cart.decrease':'Diminuer la quantité','cart.increase':'Augmenter la quantité','cart.quantityInput':'Valeur de la quantité',
            'cart.added':'Ajouté au panier','cart.removed':'Retiré du panier','cart.outOfStock':'En rupture','cart.notFound':'Produit indisponible',
            'cart.nameRequired':'Veuillez entrer un nom valide','cart.phoneRequired':'Veuillez entrer un numéro de téléphone valide',
            'cart.addressRequired':'Veuillez indiquer une adresse de livraison','cart.sending':'Envoi…','cart.success':'Commande reçue ! Nous vous contacterons rapidement.',
            'cart.error':'Échec de l’envoi. Réessayez ou contactez-nous.'
        },
        ar:{
            'nav.home':'الرئيسية','nav.about':'من نحن','nav.brands':'العلامات','nav.products':'المنتجات','nav.contact':'اتصل بنا',
            'hero.title':'المنتجات','hero.subtitle':'تصفح الفئات ← فتح المنتجات',
            'crumb.home':'الرئيسية','crumb.products':'المنتجات',
            'cats.title':'الفئات','ui.back':'← عودة إلى الفئات','ui.allBrands':'كل العلامات','ui.none':'لا توجد منتجات.','ui.brand':'العلامة',
            'ui.search':'ابحث في المنتجات…','ui.inStock':'متوفر','ui.outStock':'غير متوفر','ui.addToCart':'أضف إلى السلة','ui.cart':'السلة',
            'cart.title':'طلبك','cart.subtitle':'راجع العناصر ثم أكد بياناتك.','cart.total':'الإجمالي','cart.name':'الاسم الكامل','cart.phone':'رقم الهاتف',
            'cart.address':'عنوان التوصيل','cart.note':'ملاحظات (اختياري)','cart.submit':'أرسل الطلب','cart.empty':'سلتك فارغة.','cart.contact':'تواصل معنا',
            'cart.unit':'وحدة','cart.remove':'إزالة العنصر','cart.quantity':'الكمية','cart.decrease':'إنقاص الكمية','cart.increase':'زيادة الكمية',
            'cart.quantityInput':'قيمة الكمية','cart.added':'تمت الإضافة إلى السلة','cart.removed':'تمت الإزالة من السلة','cart.outOfStock':'غير متوفر',
            'cart.notFound':'المنتج غير متاح','cart.nameRequired':'يرجى إدخال اسم صالح','cart.phoneRequired':'يرجى إدخال رقم هاتف صالح',
            'cart.addressRequired':'يرجى إدخال عنوان التوصيل','cart.sending':'جاري الإرسال…','cart.success':'تم استلام الطلب! سنعاود الاتصال بك قريباً.',
            'cart.error':'فشل الإرسال. حاول مرة أخرى أو اتصل بنا.'
        }
    };

    function applyLang(lang){
        currentLang = lang;
        const d = I18N[lang] || I18N.en;

        // nav & hero
        document.querySelectorAll('[data-i18n]').forEach(el=>{
            const k = el.getAttribute('data-i18n');
            if(d[k]) el.textContent = d[k];
        });

        // breadcrumb (explicit HTML)
        const crumb = document.getElementById('breadcrumb');
        if(crumb){
            crumb.innerHTML = `<a href="index.html" class="hover:underline" data-i18n="crumb.home">${d['crumb.home']}</a>
                         <span class="mx-1">/</span>
                         <span class="text-gray-700 font-medium" data-i18n="crumb.products">${d['crumb.products']}</span>`;
        }

        // inputs
        if (searchBox) searchBox.placeholder = d['ui.search'];
        if (brandFilter && brandFilter.options.length) brandFilter.options[0].textContent = d['ui.allBrands'];
        if (backBtn) backBtn.textContent = d['ui.back'];

        // empty state update if present
        const empty = document.querySelector('#prodGrid .col-span-full');
        if (empty) empty.textContent = d['ui.none'];

        // dir
        document.documentElement.lang = lang;
        document.documentElement.dir = (lang==='ar') ? 'rtl' : 'ltr';

        try{ localStorage.setItem('lang', lang);}catch(e){}

        if (activeCat) {
            renderProducts();
        }
        renderCart();
    }

    // sync i18n on language change
    const savedLang = (typeof localStorage!=='undefined' && localStorage.getItem('lang')) || 'en';
    langSel.value = savedLang;
    currentLang = savedLang;
    langSel.addEventListener('change', e=>{
        applyLang(e.target.value);
    });

    // initial apply (after initial DOM is present)
    applyLang(savedLang);
</script>
</body>
</html>
