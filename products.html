<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>SOFRACOM • Products</title>

    <!-- Tailwind -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root{ --deep-navy:#0b2050; --sea:#0f3d72; --accent:#24b4ff; }
        html,body{font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
        .nav-glass{backdrop-filter:blur(10px); background:rgba(11,32,80,.55)}
        .nav-solid{background:var(--deep-navy)}
        [data-animate]{opacity:0; transform:translateY(20px); transition:all .6s ease}
        .in-view{opacity:1; transform:translateY(0)}
        .tilt{transform-style:preserve-3d; transition:transform .2s ease, box-shadow .2s ease}
        .tilt:hover{box-shadow:0 20px 45px rgba(0,0,0,.15)}
        .tilt .layer{transform:translateZ(18px)}
        .card-img{aspect-ratio:16/10; object-fit:cover}
        .price{color:#0b2050}
        .tag{background:rgba(36,180,255,.12); color:#0f3d72}
        .stock-badge{display:inline-flex; align-items:center; gap:0.35rem; padding:0.25rem 0.6rem; border-radius:999px; font-size:0.75rem; font-weight:600}
        .stock-badge--in{background:rgba(15,122,46,.12); color:#0f7a2e; border:1px solid rgba(15,122,46,.22)}
        .stock-badge--out{background:rgba(215,38,56,.12); color:#d72638; border:1px solid rgba(215,38,56,.2)}
        .product-out .card-img{filter:grayscale(.25); opacity:.8}
        .product-out .price{opacity:.7}
        .cart-fab{position:fixed; bottom:1.5rem; right:1.5rem; z-index:60; display:flex; align-items:center; gap:0.5rem; background:var(--deep-navy); color:#fff; padding:0.85rem 1.2rem; border-radius:999px; box-shadow:0 12px 24px rgba(11,32,80,.35); font-weight:600; transition:transform .2s ease, box-shadow .2s ease}
        .cart-fab:hover{transform:translateY(-2px); box-shadow:0 16px 32px rgba(11,32,80,.4)}
        .cart-overlay{position:fixed; inset:0; background:rgba(11,32,80,.35); backdrop-filter:blur(2px); z-index:70; opacity:0; pointer-events:none; transition:opacity .25s ease}
        .cart-overlay.active{opacity:1; pointer-events:auto}
        .cart-drawer{position:fixed; top:0; right:0; height:100%; width:min(420px,100vw); background:#fff; z-index:80; transform:translateX(100%); transition:transform .28s ease; display:flex; flex-direction:column; box-shadow:-8px 0 24px rgba(11,32,80,.18)}
        .cart-drawer.open{transform:translateX(0)}
        .cart-header{padding:1.25rem 1.5rem; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid rgba(15,61,114,.12)}
        .cart-body{flex:1; overflow-y:auto; padding:1rem 1.5rem}
        .cart-item{display:grid; grid-template-columns:64px 1fr; gap:0.75rem; padding:0.75rem 0; border-bottom:1px solid rgba(15,61,114,.08)}
        .cart-item:last-child{border-bottom:none}
        .cart-item img{width:64px; height:64px; object-fit:cover; border-radius:0.5rem; background:#f3f4f6}
        .cart-item-title{font-weight:600; color:#0b2050}
        .cart-qty{display:inline-flex; align-items:center; gap:0.4rem; border:1px solid rgba(11,32,80,.15); border-radius:999px; padding:0.25rem 0.6rem}
        .cart-qty button{border:none; background:transparent; font-weight:700; cursor:pointer; padding:0 0.3rem}
        .cart-qty input{width:2.5rem; border:none; text-align:center; font-weight:600; background:transparent}
        .cart-summary{padding:1rem 1.5rem; border-top:1px solid rgba(15,61,114,.12)}
        .cart-summary-row{display:flex; justify-content:space-between; font-weight:600; color:#0b2050}
        .cart-form{padding:1rem 1.5rem 1.5rem; border-top:1px solid rgba(15,61,114,.12); display:grid; gap:0.75rem}
        .cart-form label{display:grid; gap:0.35rem; font-size:0.85rem; font-weight:600; color:#0b2050}
        .cart-form input,.cart-form textarea{border:1px solid rgba(11,32,80,.18); border-radius:0.65rem; padding:0.6rem 0.75rem; font-size:0.95rem; font-family:inherit; transition:border-color .2s ease, box-shadow .2s ease}
        .cart-form input:focus,.cart-form textarea:focus{outline:none; border-color:var(--accent); box-shadow:0 0 0 3px rgba(36,180,255,.2)}
        .cart-submit{background:var(--deep-navy); color:#fff; border:none; border-radius:0.75rem; padding:0.8rem 1rem; font-weight:600; cursor:pointer; transition:background .2s ease, transform .2s ease}
        .cart-submit:disabled{opacity:.6; cursor:not-allowed}
        .cart-submit:hover:not(:disabled){background:var(--sea); transform:translateY(-1px)}
        .cart-alert{margin:0; font-size:0.85rem; font-weight:600}
        .cart-alert.error{color:#d72638}
        .cart-alert.success{color:#0f7a2e}
        .empty-cart{padding:1.25rem; text-align:center; color:#6b7280}
        @media (max-width:640px){.cart-fab{bottom:1rem; right:1rem; width:calc(100vw - 2rem); justify-content:center}}
    </style>
</head>
<body class="bg-white text-gray-800 scroll-smooth">

<!-- Header / Nav -->
<header class="sticky top-0 z-40 nav-glass text-white">
    <div class="max-w-7xl mx-auto flex items-center justify-between px-4 py-3">
        <div class="flex items-center gap-3">
            <a href="index.html" class="flex items-center gap-3">
                <img src="logo.jpeg" alt="SOFRACOM" class="h-10 w-10 rounded-lg ring-2 ring-white ring-opacity-30">
                <span class="text-xl font-extrabold tracking-wide">SOFRACOM</span>
            </a>
        </div>
        <nav class="hidden md:flex items-center gap-8 text-sm font-medium">
            <a href="index.html#home" class="hover:text-blue-200" data-i18n="nav.home">Home</a>
            <a href="index.html#about" class="hover:text-blue-200" data-i18n="nav.about">About</a>
            <a href="index.html#brands" class="hover:text-blue-200" data-i18n="nav.brands">Brands</a>
            <a href="products.html" class="hover:text-blue-200 underline" data-i18n="nav.products">Products</a>
            <a href="index.html#contact" class="hover:text-blue-200" data-i18n="nav.contact">Contact</a>
        </nav>
        <div class="flex items-center gap-3">
            <input id="searchBox" type="search" class="hidden md:block px-3 py-1.5 rounded-md bg-white bg-opacity-15 placeholder-black text-black border border-white border-opacity-20 focus:outline-none focus:ring-2 focus:ring-blue-200 w-56"
                   placeholder="Search products…">
            <select id="lang" class="px-3 py-1.5 rounded-md bg-white bg-opacity-15 text-black border border-white border-opacity-20 focus:outline-none focus:ring-2 focus:ring-blue-200">
                <option value="en">EN</option>
                <option value="fr">FR</option>
                <option value="ar">AR</option>
            </select>
        </div>
    </div>
</header>

<!-- Hero -->
<section class="relative h-64 flex items-center justify-center text-white">
    <img src="hero.jpeg" class="absolute inset-0 w-full h-full object-cover" alt="">
    <div class="absolute inset-0" style="background:linear-gradient(180deg,rgba(11,32,80,.35),rgba(11,32,80,.75))"></div>
    <div class="relative text-center px-6" data-animate>
        <h1 class="text-3xl sm:text-4xl font-extrabold" data-i18n="hero.title">Products</h1>
        <p class="text-blue-100 mt-2" data-i18n="hero.subtitle">Browse categories → open products</p>
    </div>
</section>

<main class="max-w-7xl mx-auto px-6 py-12">
    <!-- Breadcrumb / Controls -->
    <div class="flex flex-wrap items-center justify-between gap-3 mb-6">
        <nav class="text-sm text-gray-500" id="breadcrumb">
            <a href="index.html" class="hover:underline" data-i18n="crumb.home">Home</a>
            <span class="mx-1">/</span>
            <span class="text-gray-700 font-medium" data-i18n="crumb.products">Products</span>
        </nav>

        <div class="flex items-center gap-3">
            <select id="brandFilter" class="px-3 py-2 rounded-lg border focus:ring-2 focus:ring-blue-200 hidden"></select>
            <button id="backBtn" class="px-3 py-2 rounded-lg border hidden" data-i18n="ui.back">← Back to categories</button>
        </div>
    </div>

    <!-- Categories -->
    <section id="categoriesSection">
        <h2 class="text-2xl font-extrabold mb-4" data-i18n="cats.title">Categories</h2>
        <div id="catGrid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </section>

    <!-- Products -->
    <section id="productsSection" class="hidden">
        <div class="flex items-end justify-between gap-4">
            <div>
                <h2 id="catTitle" class="text-2xl font-extrabold"></h2>
                <p id="catDesc" class="text-gray-600 mt-1"></p>
            </div>
        </div>
        <div class="mt-6 grid sm:grid-cols-2 lg:grid-cols-3 gap-6" id="prodGrid"></div>
    </section>
</main>

<button id="cartFab" class="cart-fab" type="button">
    <span data-i18n="ui.cart">Cart</span>
    <span class="px-2 py-1 rounded-full bg-white/15 text-sm font-semibold" id="cartCount">0</span>
</button>

<div id="cartOverlay" class="cart-overlay"></div>

<aside id="cartDrawer" class="cart-drawer" aria-hidden="true" aria-labelledby="cartTitle">
    <div class="cart-header">
        <div>
            <h3 id="cartTitle" class="text-lg font-semibold text-gray-900" data-i18n="cart.title">Your order</h3>
            <p class="text-sm text-gray-500" data-i18n="cart.subtitle">Review items then confirm your details.</p>
        </div>
        <button id="cartClose" type="button" aria-label="Close cart" class="text-2xl leading-none text-gray-500 hover:text-gray-800">×</button>
    </div>
    <div class="cart-body" id="cartItems"></div>
    <div class="cart-summary">
        <div class="cart-summary-row">
            <span data-i18n="cart.total">Total</span>
            <span id="cartTotal">0 TND</span>
        </div>
        <p id="cartAlert" class="cart-alert" role="status"></p>
    </div>
    <form id="checkoutForm" class="cart-form" novalidate>
        <label>
            <span data-i18n="cart.name">Full name</span>
            <input type="text" name="name" autocomplete="name" required minlength="2" placeholder="John Doe" />
        </label>
        <label>
            <span data-i18n="cart.phone">Phone</span>
            <input type="tel" name="phone" autocomplete="tel" required minlength="6" placeholder="+216 00 000 000" />
        </label>
        <label>
            <span data-i18n="cart.address">Delivery address</span>
            <textarea name="address" rows="2" required placeholder="Marina Monastir, dock 5"></textarea>
        </label>
        <label>
            <span data-i18n="cart.note">Notes (optional)</span>
            <textarea name="notes" rows="2" placeholder="Preferred delivery time, marina berth, etc."></textarea>
        </label>
        <button id="cartSubmitBtn" type="submit" class="cart-submit" data-i18n="cart.submit">Send order</button>
    </form>
</aside>

<!-- Footer -->
<footer class="bg-blue-950 text-blue-100 mt-16">
    <div class="max-w-7xl mx-auto px-6 py-6 text-sm opacity-80 flex items-center justify-between">
        <span>© <span id="y"></span> SOFRACOM</span>
        <a href="#" class="hover:underline">Back to top</a>
    </div>
</footer>

<!-- Embedded demo data (used offline / file:// fallback) -->
<script id="productsData" type="application/json">
    {
        "categories": [
            {
                "name": "Antifouling & Coatings",
                "slug": "antifouling-coatings",
                "image": "assets/bosch.png",
                "description": "Bottom paints, primers, and topcoats for local waters.",
                "products": [
                    {"title":"Jotun SeaForce 30","image":"assets/bosch.png","description":"Self-polishing antifouling for sailing yachts and motorboats.","brand":"JOTUN","usage":["Antifouling","Warm waters","Self-polishing"],"price":380,"stock":"in"},
                    {"title":"Hempel Mille NCT","image":"assets/bosch.png","description":"High-performance antifouling with advanced binder.","brand":"HEMPEL","usage":["Antifouling","Long-lasting","Easy apply"],"price":420,"stock":"in"}
                ]
            },
            {
                "name": "Sealants & Adhesives",
                "slug": "sealants-adhesives",
                "image": "assets/bosch.png",
                "description": "Marine sealants for deck hardware, teak, hatches, and glazing.",
                "products": [
                    {"title":"Sika 291i","image":"assets/bosch.png","description":"Multi-purpose marine sealant/adhesive for general use.","brand":"SIKA","usage":["Deck hardware","General bonding","Flexible"],"price":65,"stock":"in"},
                    {"title":"Sika 295 UV","image":"assets/bosch.png","description":"UV-resistant adhesive for organic glass (PMMA/PC).","brand":"SIKA","usage":["Windows","UV-resistant","Elastic"],"price":89,"stock":"in"}
                ]
            },
            {
                "name": "Oils, Filters & Batteries",
                "slug": "oils-filters-batteries",
                "image": "assets/bosch.png",
                "description": "Engine oils, filters and reliable onboard power.",
                "products": [
                    {"title":"Shell Rimula R4 15W-40","image":"assets/bosch.png","description":"Heavy-duty engine oil for marine diesel.","brand":"SHELL","usage":["Engine","Protection"],"price":120,"stock":"in"},
                    {"title":"VARTA Blue Dynamic 75Ah","image":"assets/bosch.png","description":"Marine battery with strong cold cranking performance.","brand":"VARTA","usage":["Battery","Electrical"],"price":780,"stock":"in"}
                ]
            }
        ]
    }
</script>

<script>
    // Sticky header solid on scroll
    const header = document.querySelector('header');
    addEventListener('scroll', () => {
        if (scrollY > 40) header.classList.add('nav-solid'); else header.classList.remove('nav-solid');
    });
    document.getElementById('y').textContent = new Date().getFullYear();

    // Intersection reveal
    const io = new IntersectionObserver((es)=> es.forEach(e=>{ if(e.isIntersecting){e.target.classList.add('in-view'); io.unobserve(e.target);} }), {threshold:.15});
    document.querySelectorAll('[data-animate]').forEach(el=>io.observe(el));

    // Tilt
    function tiltify(card){
        const r=12;
        function move(e){ const b=card.getBoundingClientRect(), px=(e.clientX-b.left)/b.width, py=(e.clientY-b.top)/b.height; card.style.transform=`rotateX(${(0.5-py)*r}deg) rotateY(${(px-0.5)*r}deg)`;}
        function reset(){ card.style.transform='rotateX(0) rotateY(0)';}
        card.addEventListener('mousemove',move); card.addEventListener('mouseleave',reset);
    }

    // ==== Data load (fetch + fallback to embedded JSON for file://) ====
    const DATA_URL = './assets/data/products.json';
    const catGrid = document.getElementById('catGrid');
    const prodGrid = document.getElementById('prodGrid');
    const categoriesSection = document.getElementById('categoriesSection');
    const productsSection = document.getElementById('productsSection');
    const backBtn = document.getElementById('backBtn');
    const brandFilter = document.getElementById('brandFilter');
    const searchBox = document.getElementById('searchBox');
    const catTitle = document.getElementById('catTitle');
    const catDesc = document.getElementById('catDesc');
    const breadcrumb = document.getElementById('breadcrumb');
    const langSel = document.getElementById('lang');

    const CART_KEY = 'sofracom.cart.v1';
    const PRODUCT_INDEX = {};
    const cartFab = document.getElementById('cartFab');
    const cartOverlay = document.getElementById('cartOverlay');
    const cartDrawer = document.getElementById('cartDrawer');
    const cartItemsEl = document.getElementById('cartItems');
    const cartCountEl = document.getElementById('cartCount');
    const cartTotalEl = document.getElementById('cartTotal');
    const cartAlert = document.getElementById('cartAlert');
    const cartCloseBtn = document.getElementById('cartClose');
    const cartForm = document.getElementById('checkoutForm');
    const cartSubmitBtn = document.getElementById('cartSubmitBtn');

    let STORE = null, activeCat = null, filtered = [];
    let currentLang = 'en';
    let cart = [];

    function loadCart(){
        if (typeof localStorage === 'undefined') return [];
        try {
            const raw = localStorage.getItem(CART_KEY);
            if (!raw) return [];
            const parsed = JSON.parse(raw);
            if (!Array.isArray(parsed)) return [];
            return parsed.map(item => ({
                ...item,
                quantity: Number.isFinite(item.quantity) && item.quantity > 0
                    ? Math.max(1, Math.trunc(item.quantity))
                    : 1,
            }));
        } catch (error) {
            console.warn('cart: failed to read storage', error);
            return [];
        }
    }

    function saveCart(){
        if (typeof localStorage === 'undefined') return;
        try {
            localStorage.setItem(CART_KEY, JSON.stringify(cart));
        } catch (error) {
            console.warn('cart: failed to persist', error);
        }
    }

    function calculateCartTotal(){
        return cart.reduce((total, item) => {
            if (typeof item.price === 'number') {
                return total + item.price * item.quantity;
            }
            return total;
        }, 0);
    }

    function updateCartCount(){
        const count = cart.reduce((sum, item) => sum + item.quantity, 0);
        cartCountEl.textContent = count;
        cartFab.dataset.count = count;
    }

    function getCartQuantity(id){
        const item = cart.find(entry => entry.id === id);
        return item ? item.quantity : 0;
    }

    function showCartAlert(message = '', type = ''){
        cartAlert.textContent = message;
        cartAlert.classList.remove('error', 'success');
        if (message && type) {
            cartAlert.classList.add(type);
        }
    }

    function renderCart(){
        const total = calculateCartTotal();
        if (!cart.length){
            cartItemsEl.innerHTML = `<div class="empty-cart" data-i18n="cart.empty">${getLabel('cart.empty')}</div>`;
            cartTotalEl.textContent = formatPrice(0);
            cartSubmitBtn.disabled = true;
            return;
        }

        cartSubmitBtn.disabled = false;
        cartItemsEl.innerHTML = cart.map(item => {
            const lineTotal = typeof item.price === 'number'
                ? formatPrice(item.price * item.quantity)
                : getLabel('cart.contact');
            const unitPrice = typeof item.price === 'number'
                ? `<span class="text-xs text-gray-500">${formatPrice(item.price)} / ${getLabel('cart.unit')}</span>`
                : '';
            return `
        <div class="cart-item" data-id="${item.id}">
            <img src="${item.image}" alt="${item.title}">
            <div>
                <div class="flex items-start justify-between gap-2">
                    <div>
                        <p class="cart-item-title">${item.title}</p>
                        <p class="text-xs text-gray-500">${item.category || ''}</p>
                    </div>
                    <button type="button" class="text-sm text-red-500 hover:text-red-600" data-action="remove" aria-label="${getLabel('cart.remove')}">×</button>
                </div>
                <div class="mt-3 flex items-center justify-between gap-3">
                    <div class="cart-qty" aria-label="${getLabel('cart.quantity')}">
                        <button type="button" data-action="decrement" aria-label="${getLabel('cart.decrease')}">−</button>
                        <input type="number" min="1" step="1" value="${item.quantity}" data-action="quantity" aria-label="${getLabel('cart.quantityInput')}">
                        <button type="button" data-action="increment" aria-label="${getLabel('cart.increase')}">+</button>
                    </div>
                    <div class="text-right">
                        <div class="font-semibold price">${lineTotal}</div>
                        ${unitPrice}
                    </div>
                </div>
            </div>
        </div>`;
        }).join('');

        cartTotalEl.textContent = total > 0 ? formatPrice(total) : getLabel('cart.contact');
    }

    function openCart(){
        cartDrawer.classList.add('open');
        cartDrawer.setAttribute('aria-hidden', 'false');
        cartOverlay.classList.add('active');
    }

    function closeCart(){
        cartDrawer.classList.remove('open');
        cartDrawer.setAttribute('aria-hidden', 'true');
        cartOverlay.classList.remove('active');
    }

    function addToCartById(id, quantity = 1){
        const product = PRODUCT_INDEX[id];
        if (!product){
            showCartAlert(getLabel('cart.notFound'), 'error');
            return;
        }
        if (product.stock === 'out'){
            showCartAlert(getLabel('cart.outOfStock'), 'error');
            return;
        }

        const existing = cart.find(item => item.id === id);
        if (existing){
            existing.quantity += quantity;
        } else {
            const numericPrice = typeof product.price === 'number' ? product.price : Number(product.price);
            cart.push({
                id,
                title: product.title,
                price: Number.isFinite(numericPrice) ? numericPrice : null,
                quantity: Math.max(1, quantity),
                image: product.image || 'assets/placeholder-prod.jpg',
                category: product.categoryName || '',
            });
        }

        saveCart();
        renderCart();
        updateCartCount();
        showCartAlert(getLabel('cart.added'), 'success');
    }

    function updateCartQuantity(id, value){
        const item = cart.find(entry => entry.id === id);
        if (!item) return;
        const next = Number.isFinite(value) ? Math.trunc(value) : 1;
        if (next <= 0){
            removeFromCart(id);
            return;
        }
        item.quantity = Math.max(1, next);
        saveCart();
        renderCart();
        updateCartCount();
    }

    function removeFromCart(id){
        cart = cart.filter(entry => entry.id !== id);
        saveCart();
        renderCart();
        updateCartCount();
        showCartAlert(getLabel('cart.removed'), 'success');
    }

    cart = loadCart();
    updateCartCount();

    cartFab.addEventListener('click', () => {
        renderCart();
        showCartAlert('', '');
        openCart();
    });
    cartOverlay.addEventListener('click', closeCart);
    cartCloseBtn.addEventListener('click', closeCart);
    document.addEventListener('keydown', event => {
        if (event.key === 'Escape') closeCart();
    });

    cartItemsEl.addEventListener('click', event => {
        const action = event.target.dataset.action;
        if (!action) return;
        const row = event.target.closest('[data-id]');
        if (!row) return;
        const id = row.dataset.id;
        if (action === 'remove'){
            removeFromCart(id);
        } else if (action === 'increment'){
            updateCartQuantity(id, getCartQuantity(id) + 1);
        } else if (action === 'decrement'){
            updateCartQuantity(id, getCartQuantity(id) - 1);
        }
    });

    cartItemsEl.addEventListener('change', event => {
        if (event.target.dataset.action !== 'quantity') return;
        const row = event.target.closest('[data-id]');
        if (!row) return;
        const id = row.dataset.id;
        const value = Number.parseInt(event.target.value, 10);
        if (!Number.isFinite(value)){
            event.target.value = getCartQuantity(id);
            return;
        }
        updateCartQuantity(id, value);
    });

    cartForm.addEventListener('submit', handleCheckoutSubmit);

    async function handleCheckoutSubmit(event){
        event.preventDefault();
        if (!cart.length){
            showCartAlert(getLabel('cart.empty'), 'error');
            return;
        }

        const formData = new FormData(cartForm);
        const customer = {
            name: (formData.get('name') || '').trim(),
            phone: (formData.get('phone') || '').trim(),
            address: (formData.get('address') || '').trim(),
            notes: (formData.get('notes') || '').trim(),
        };

        if (customer.name.length < 2){
            showCartAlert(getLabel('cart.nameRequired'), 'error');
            return;
        }
        if (customer.phone.length < 6){
            showCartAlert(getLabel('cart.phoneRequired'), 'error');
            return;
        }
        if (customer.address.length < 6){
            showCartAlert(getLabel('cart.addressRequired'), 'error');
            return;
        }

        const payload = {
            customer,
            items: cart.map(item => ({
                id: item.id,
                title: item.title,
                price: item.price,
                quantity: item.quantity,
                image: item.image,
                category: item.category,
            })),
            total: calculateCartTotal(),
            currency: 'TND',
        };

        const defaultLabel = cartSubmitBtn.textContent;
        cartSubmitBtn.disabled = true;
        cartSubmitBtn.textContent = getLabel('cart.sending');
        showCartAlert('', '');

        try {
            const response = await fetch('/api/create-order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });
            const result = await response.json().catch(() => ({ ok: false }));
            if (!response.ok || !result.ok){
                throw new Error(result.error || `HTTP ${response.status}`);
            }
            cart = [];
            saveCart();
            renderCart();
            updateCartCount();
            cartForm.reset();
            showCartAlert(getLabel('cart.success'), 'success');
        } catch (error){
            console.error('order submit failed', error);
            showCartAlert(getLabel('cart.error'), 'error');
        } finally {
            cartSubmitBtn.disabled = false;
            cartSubmitBtn.textContent = defaultLabel;
        }
    }

    function getEmbeddedJSON(){
        try { const el = document.getElementById('productsData'); return el ? JSON.parse(el.textContent) : null; }
        catch(e){ return null; }
    }

    (async () => {
        try {
            const r = await fetch(DATA_URL, {cache:'no-cache'});
            if (!r.ok) throw new Error('HTTP '+r.status);
            STORE = await r.json();
        } catch (e) {
            STORE = getEmbeddedJSON();
            if (!STORE){
                catGrid.innerHTML = `<div class="text-red-600">Failed to load products data.</div>`;
                console.error(e);
                return;
            }
        }
        renderCategories(STORE.categories);
        const p = new URLSearchParams(location.search);
        const slug = p.get('cat'); if (slug) openCategory(slug);
        applyLang((localStorage.getItem('lang')||'en')); // sync i18n once data is drawn
    })();

    function slugify(s){return s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');}

    function renderCategories(cats){
        categoriesSection.classList.remove('hidden');
        productsSection.classList.add('hidden');
        backBtn.classList.add('hidden'); brandFilter.classList.add('hidden'); searchBox.classList.add('hidden');

        breadcrumb.innerHTML = `<a href="index.html" class="hover:underline" data-i18n="crumb.home">Home</a> <span class="mx-1">/</span> <span class="text-gray-700 font-medium" data-i18n="crumb.products">Products</span>`;

        catGrid.innerHTML = cats.map(c => {
            const s = c.slug || slugify(c.name);
            const img = c.image || 'assets/placeholder-cat.jpg';
            return `
        <button data-cat="${s}" class="tilt group text-left bg-white rounded-2xl overflow-hidden shadow hover:shadow-xl transform transition">
          <div class="layer">
            <img src="${img}" alt="${c.name}" class="card-img w-full">
            <div class="p-4">
              <h3 class="text-lg font-semibold text-gray-900 group-hover:text-blue-900">${c.name}</h3>
              ${c.description ? `<p class="text-sm text-gray-600 mt-1">${c.description}</p>`:''}
            </div>
          </div>
        </button>`;
        }).join('');
        catGrid.querySelectorAll('.tilt').forEach(tiltify);
        catGrid.querySelectorAll('[data-cat]').forEach(btn => btn.addEventListener('click', () => openCategory(btn.dataset.cat)));
    }

    function openCategory(slug){
        const cat = STORE.categories.find(c => (c.slug || slugify(c.name)) === slug);
        if (!cat){ alert('Category not found'); return; }
        activeCat = cat;

        categoriesSection.classList.add('hidden');
        productsSection.classList.remove('hidden');
        backBtn.classList.remove('hidden'); brandFilter.classList.remove('hidden'); searchBox.classList.remove('hidden');

        breadcrumb.innerHTML = `<a href="index.html" class="hover:underline" data-i18n="crumb.home">Home</a> <span class="mx-1">/</span>
                            <a href="products.html" class="hover:underline" data-i18n="crumb.products">Products</a> <span class="mx-1">/</span>
                            <span class="text-gray-700 font-medium">${cat.name}</span>`;

        catTitle.textContent = cat.name;
        catDesc.textContent = cat.description || '';

        const brands = Array.from(new Set(cat.products.map(p=>p.brand).filter(Boolean))).sort();
        brandFilter.innerHTML = `<option value="">All brands</option>` + brands.map(b=>`<option>${b}</option>`).join('');

        filtered = cat.products.slice();
        searchBox.value=''; brandFilter.value='';
        renderProducts();
        history.replaceState(null,'',`?cat=${encodeURIComponent(cat.slug || slugify(cat.name))}`);
    }

    function renderProducts(){
        const list = filtered;
        Object.keys(PRODUCT_INDEX).forEach(key => delete PRODUCT_INDEX[key]);

        if (!list.length){
            prodGrid.innerHTML = `<div class="col-span-full text-gray-500" data-i18n="ui.none">${getLabel('ui.none')}</div>`;
            return;
        }

        const catSlug = activeCat ? (activeCat.slug || slugify(activeCat.name)) : 'catalogue';
        prodGrid.innerHTML = list.map((p, idx) => {
            const id = `${catSlug}::${slugify(p.title || 'item')}-${idx}`;
            const numericPrice = typeof p.price === 'number' ? p.price : Number(p.price);
            PRODUCT_INDEX[id] = {
                ...p,
                price: Number.isFinite(numericPrice) ? numericPrice : null,
                image: p.image || 'assets/placeholder-prod.jpg',
                categorySlug: catSlug,
                categoryName: activeCat ? activeCat.name : '',
                stock: p.stock === 'out' ? 'out' : 'in',
            };
            return productCard(activeCat, p, id);
        }).join('');

        prodGrid.querySelectorAll('.tilt').forEach(tiltify);
        prodGrid.querySelectorAll('[data-product-id]').forEach(btn => {
            btn.addEventListener('click', event => {
                const id = event.currentTarget.dataset.productId;
                addToCartById(id, 1);
                openCart();
            });
        });
    }

    function getLabel(key){
        const dictionaries = (typeof I18N !== 'undefined' && I18N) ? I18N : { en: {} };
        const dict = dictionaries[currentLang] || dictionaries.en || {};
        return dict[key] || (dictionaries.en ? dictionaries.en[key] : key) || key;
    }

    function productCard(category, p, id){
        const img = p.image || 'assets/placeholder-prod.jpg';
        const usage = Array.isArray(p.usage) ? p.usage.map(u=>`<span class="px-2 py-1 rounded tag text-xs">${u}</span>`).join(' ') : '';
        const price = (p.price!=null && Number.isFinite(Number(p.price))) ? `<span class="font-bold price">${formatPrice(Number(p.price))}</span>` : '';
        const stock = (p.stock === 'out') ? 'out' : 'in';
        const stockKey = stock === 'in' ? 'ui.inStock' : 'ui.outStock';
        const stockBadge = `<span class="stock-badge ${stock === 'in' ? 'stock-badge--in' : 'stock-badge--out'}" data-i18n="${stockKey}">${getLabel(stockKey)}</span>`;
        const metaItems = [price, stockBadge].filter(Boolean).join('');
        const meta = metaItems ? `<div class="mt-3 flex flex-wrap items-center justify-between gap-2">${metaItems}</div>` : '';
        const brandLabel = getLabel('ui.brand');
        const buttonLabel = stock === 'out' ? getLabel('ui.outStock') : getLabel('ui.addToCart');
        const stateClass = stock === 'out' ? ' product-out' : '';
        const button = `<button type="button" class="mt-4 inline-flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-blue-600 text-white text-sm font-semibold shadow transition hover:bg-blue-700 disabled:opacity-60 disabled:cursor-not-allowed" data-product-id="${id}" ${stock === 'out' ? 'disabled' : ''}>${buttonLabel}</button>`;
        return `
      <article class="tilt bg-white rounded-2xl overflow-hidden shadow hover:shadow-xl transform transition${stateClass}">
        <div class="layer">
          <img src="${img}" alt="${p.title}" class="card-img w-full">
          <div class="p-4">
            <h3 class="text-lg font-semibold text-gray-900">${p.title}</h3>
            <p class="text-sm text-gray-600 mt-1">${p.description||''}</p>
            <div class="mt-2 text-xs text-gray-500"><span data-i18n="ui.brand">${brandLabel}</span>: <b>${p.brand||'—'}</b></div>
            <div class="mt-3 flex flex-wrap gap-2">${usage}</div>
            ${meta}
            ${button}
          </div>
        </div>
      </article>`;
    }

    function formatPrice(v){
        try { return new Intl.NumberFormat('fr-TN',{style:'currency',currency:'TND'}).format(v); }
        catch(e){ return v + ' TND'; }
    }

    // Filters
    brandFilter.addEventListener('change', applyFilters);
    searchBox.addEventListener('input', debounce(applyFilters, 120));
    backBtn.addEventListener('click', ()=>{ history.replaceState(null,'','products.html'); renderCategories(STORE.categories); applyLang((localStorage.getItem('lang')||'en')); });

    function applyFilters(){
        const q = (searchBox.value||'').toLowerCase();
        const b = brandFilter.value||'';
        let list = activeCat.products.slice();
        if (b) list = list.filter(p=> (p.brand||'').toLowerCase() === b.toLowerCase());
        if (q) list = list.filter(p =>
            (p.title||'').toLowerCase().includes(q) ||
            (p.description||'').toLowerCase().includes(q) ||
            (p.brand||'').toLowerCase().includes(q) ||
            (Array.isArray(p.usage) ? p.usage.join(' ').toLowerCase().includes(q) : false)
        );
        filtered = list;
        renderProducts();
    }

    function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

    // ======= i18n (EN/FR/AR + RTL) =======
    const I18N = {
        en:{
            'nav.home':'Home','nav.about':'About','nav.brands':'Brands','nav.products':'Products','nav.contact':'Contact',
            'hero.title':'Products','hero.subtitle':'Browse categories → open products',
            'crumb.home':'Home','crumb.products':'Products',
            'cats.title':'Categories','ui.back':'← Back to categories','ui.allBrands':'All brands','ui.none':'No products found.','ui.brand':'Brand',
            'ui.search':'Search products…','ui.inStock':'In stock','ui.outStock':'Out of stock','ui.addToCart':'Add to cart','ui.cart':'Cart',
            'cart.title':'Your order','cart.subtitle':'Review items then confirm your details.','cart.total':'Total','cart.name':'Full name','cart.phone':'Phone',
            'cart.address':'Delivery address','cart.note':'Notes (optional)','cart.submit':'Send order','cart.empty':'Your cart is empty.','cart.contact':'Contact us',
            'cart.unit':'unit','cart.remove':'Remove item','cart.quantity':'Quantity','cart.decrease':'Decrease quantity','cart.increase':'Increase quantity',
            'cart.quantityInput':'Quantity value','cart.added':'Added to cart','cart.removed':'Removed from cart','cart.outOfStock':'Out of stock',
            'cart.notFound':'Product no longer available','cart.nameRequired':'Enter a valid name to continue','cart.phoneRequired':'Enter a valid phone number',
            'cart.addressRequired':'Enter a delivery address','cart.sending':'Sending…','cart.success':'Order received! We will contact you shortly.',
            'cart.error':'Submission failed. Please try again or contact us.'
        },
        fr:{
            'nav.home':'Accueil','nav.about':'À propos','nav.brands':'Marques','nav.products':'Produits','nav.contact':'Contact',
            'hero.title':'Produits','hero.subtitle':'Parcourez les catégories → ouvrez les produits',
            'crumb.home':'Accueil','crumb.products':'Produits',
            'cats.title':'Catégories','ui.back':'← Retour aux catégories','ui.allBrands':'Toutes les marques','ui.none':'Aucun produit trouvé.','ui.brand':'Marque',
            'ui.search':'Rechercher des produits…','ui.inStock':'En stock','ui.outStock':'En rupture','ui.addToCart':'Ajouter au panier','ui.cart':'Panier',
            'cart.title':'Votre commande','cart.subtitle':'Vérifiez les articles puis confirmez vos coordonnées.','cart.total':'Total','cart.name':'Nom complet',
            'cart.phone':'Téléphone','cart.address':'Adresse de livraison','cart.note':'Notes (optionnel)','cart.submit':'Envoyer la commande',
            'cart.empty':'Votre panier est vide.','cart.contact':'Nous contacter','cart.unit':'unité','cart.remove':'Retirer l’article','cart.quantity':'Quantité',
            'cart.decrease':'Diminuer la quantité','cart.increase':'Augmenter la quantité','cart.quantityInput':'Valeur de la quantité',
            'cart.added':'Ajouté au panier','cart.removed':'Retiré du panier','cart.outOfStock':'En rupture','cart.notFound':'Produit indisponible',
            'cart.nameRequired':'Veuillez entrer un nom valide','cart.phoneRequired':'Veuillez entrer un numéro de téléphone valide',
            'cart.addressRequired':'Veuillez indiquer une adresse de livraison','cart.sending':'Envoi…','cart.success':'Commande reçue ! Nous vous contacterons rapidement.',
            'cart.error':'Échec de l’envoi. Réessayez ou contactez-nous.'
        },
        ar:{
            'nav.home':'الرئيسية','nav.about':'من نحن','nav.brands':'العلامات','nav.products':'المنتجات','nav.contact':'اتصل بنا',
            'hero.title':'المنتجات','hero.subtitle':'تصفح الفئات ← فتح المنتجات',
            'crumb.home':'الرئيسية','crumb.products':'المنتجات',
            'cats.title':'الفئات','ui.back':'← عودة إلى الفئات','ui.allBrands':'كل العلامات','ui.none':'لا توجد منتجات.','ui.brand':'العلامة',
            'ui.search':'ابحث في المنتجات…','ui.inStock':'متوفر','ui.outStock':'غير متوفر','ui.addToCart':'أضف إلى السلة','ui.cart':'السلة',
            'cart.title':'طلبك','cart.subtitle':'راجع العناصر ثم أكد بياناتك.','cart.total':'الإجمالي','cart.name':'الاسم الكامل','cart.phone':'رقم الهاتف',
            'cart.address':'عنوان التوصيل','cart.note':'ملاحظات (اختياري)','cart.submit':'أرسل الطلب','cart.empty':'سلتك فارغة.','cart.contact':'تواصل معنا',
            'cart.unit':'وحدة','cart.remove':'إزالة العنصر','cart.quantity':'الكمية','cart.decrease':'إنقاص الكمية','cart.increase':'زيادة الكمية',
            'cart.quantityInput':'قيمة الكمية','cart.added':'تمت الإضافة إلى السلة','cart.removed':'تمت الإزالة من السلة','cart.outOfStock':'غير متوفر',
            'cart.notFound':'المنتج غير متاح','cart.nameRequired':'يرجى إدخال اسم صالح','cart.phoneRequired':'يرجى إدخال رقم هاتف صالح',
            'cart.addressRequired':'يرجى إدخال عنوان التوصيل','cart.sending':'جاري الإرسال…','cart.success':'تم استلام الطلب! سنعاود الاتصال بك قريباً.',
            'cart.error':'فشل الإرسال. حاول مرة أخرى أو اتصل بنا.'
        }
    };

    function applyLang(lang){
        currentLang = lang;
        const d = I18N[lang] || I18N.en;

        // nav & hero
        document.querySelectorAll('[data-i18n]').forEach(el=>{
            const k = el.getAttribute('data-i18n');
            if(d[k]) el.textContent = d[k];
        });

        // breadcrumb (explicit HTML)
        const crumb = document.getElementById('breadcrumb');
        if(crumb){
            crumb.innerHTML = `<a href="index.html" class="hover:underline" data-i18n="crumb.home">${d['crumb.home']}</a>
                         <span class="mx-1">/</span>
                         <span class="text-gray-700 font-medium" data-i18n="crumb.products">${d['crumb.products']}</span>`;
        }

        // inputs
        if (searchBox) searchBox.placeholder = d['ui.search'];
        if (brandFilter && brandFilter.options.length) brandFilter.options[0].textContent = d['ui.allBrands'];
        if (backBtn) backBtn.textContent = d['ui.back'];

        // empty state update if present
        const empty = document.querySelector('#prodGrid .col-span-full');
        if (empty) empty.textContent = d['ui.none'];

        // dir
        document.documentElement.lang = lang;
        document.documentElement.dir = (lang==='ar') ? 'rtl' : 'ltr';

        try{ localStorage.setItem('lang', lang);}catch(e){}

        if (activeCat) {
            renderProducts();
        }
        renderCart();
    }

    // sync i18n on language change
    const savedLang = (typeof localStorage!=='undefined' && localStorage.getItem('lang')) || 'en';
    langSel.value = savedLang;
    currentLang = savedLang;
    langSel.addEventListener('change', e=>{
        applyLang(e.target.value);
    });

    // initial apply (after initial DOM is present)
    applyLang(savedLang);
</script>
</body>
</html>
